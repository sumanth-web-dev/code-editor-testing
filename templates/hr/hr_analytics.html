{% extends 'base/hr.html' %}

{% block title %}HR Analytics - HR App{% endblock %}

{% block css %}
{{ super() }}
<style>
    .table-container {
        max-width: 1100px;
        margin: 40px auto;
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Inter', sans-serif;
    }
    table thead {
        background: #4e54c8;
        color: #fff;
    }
    table th, table td {
        padding: 14px 18px;
        border: 1px solid #e0e0e0;
        text-align: left;
    }
    table tr:nth-child(even) {
        background: #f9f9f9;
    }
    table tr:hover {
        background: #f1f5ff;
    }
    .hr-nav {
        text-align: center;
        margin: 30px 0;
    }
    .hr-nav a, .generate-btn {
        display: inline-block;
        background: #fff;
        color: #4e54c8;
        padding: 12px 26px;
        margin: 6px;
        border-radius: 30px;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
    }
    .hr-nav a:hover, .generate-btn:hover {
        background: #4e54c8;
        color: #fff;
        transform: translateY(-2px);
    }
    .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }
    .loader {
        border: 8px solid #e0e0e0;
        border-top: 8px solid #4e54c8;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4e54c8;
        color: #fff;
        padding: 14px 24px;
        border-radius: 6px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10000;
    }
    .toast.show {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
 {% include 'base/_flashes.html' %}
<div class="hr-nav">
    <a href="{{ url_for('hr.view_interview_details') }}">ðŸ“Š View Interview Details</a>
    <a href="{{ url_for('hr.student_stats') }}">ðŸ“Š View Student Stats</a>
    <a href="{{ url_for('hr.score_graph') }}">ðŸ“ˆ View Interview Scores</a>
</div>

<div id="toast" class="toast">âœ… Evaluation complete!</div>
{% endblock %}

{% block js %}
<!-- <script>
// GLOBAL GENERATE BUTTON CLICK
document.getElementById('generate-answers-btn').addEventListener('click', function() {
    const btn = this;
    const loader = document.getElementById('loader');

    btn.disabled = true;
    btn.textContent = "â³ Evaluating...";
    loader.style.display = 'flex';

    const rows = document.querySelectorAll('tbody tr[data-qid]');
    let total = rows.length;
    let completed = 0;

    if (total === 0) {
        loader.style.display = 'none';
        btn.disabled = false;
        btn.textContent = "ðŸ’¡ Generate LLM Answers & Scores";
        showToast("No questions found.");
        return;
    }

    rows.forEach(row => {
        evaluateRow(row, () => {
            completed++;
            if (completed === total) {
                loader.style.display = 'none';
                btn.disabled = false;
                btn.textContent = "ðŸ’¡ Generate LLM Answers & Scores";
                showToast("âœ… All Evaluated!");
            }
        });
    });
});

// SINGLE ROW GENERATE BUTTONS
document.querySelectorAll('.single-generate-btn').forEach(button => {
    button.addEventListener('click', function() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        const row = this.closest('tr');
        evaluateRow(row, () => {
            loader.style.display = 'none';
            showToast("âœ… Row Evaluated!");
        });
    });
});

// EVALUATE A SINGLE ROW
function evaluateRow(row, callback) {
    const qid = row.dataset.qid;
    const answerText = row.children[4].textContent.trim();
    const llmAnswerCell = row.querySelector('.llm-answer');
    const scoreCell = row.querySelector('.score');

    if (!answerText) {
        callback();
        return;
    }

    fetch("/hr/evaluate_answer", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question_id: qid, candidate_answer: answerText })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.ideal_answer) {
            llmAnswerCell.textContent = data.ideal_answer;
            scoreCell.textContent = data.score;
        }
    })
    .catch(err => console.error("Error evaluating answer", err))
    .finally(() => callback());
}

// SHOW TOAST MESSAGE
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
}
</script> -->
{% endblock %}
